FROM kalilinux/kali-rolling

# Configure environment variables to optimize installations
ENV DEBIAN_FRONTEND=noninteractive \
    PATH=$PATH:/root/go/bin \
    GOPATH=/root/go

WORKDIR /pentest

# Optimize layer order for better Docker cache
# Install system tools in a single layer
RUN apt update && apt upgrade -y \
    && apt install -y \
        nmap \
        whatweb \
        curl \
        wordlists \
        hydra \
        sshpass \
        metasploit-framework \
        nuclei \
        golang-go \
        wget \
        git \
    && rm -rf /var/lib/apt/lists/* \
    && apt clean \
    && apt autoclean

# Configure Go and install Go tools in a separate layer
RUN echo 'export PATH=$PATH:/root/go/bin' >> ~/.bashrc \
    && /bin/bash -c "source ~/.bashrc" \
    && go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest \
    && httpx -version

# Decompress rockyou.txt and create userlist in a separate layer
RUN gzip -d /usr/share/wordlists/rockyou.txt.gz 2>/dev/null || true \
    && echo -e "root\nadmin\nuser\ntest\nguest\nsolana\nvalidator\nrpc" > /usr/share/wordlists/usernames.txt

# Copy scripts at the end to optimize cache
COPY setup_tools.sh .
COPY aut_pentest_solana_et1_v3.12.sh .

# Give execution permissions
RUN chmod +x setup_tools.sh aut_pentest_solana_et1_v3.12.sh

# Create results directory
RUN mkdir -p /pentest/results

# Configure tmpfs for better performance
VOLUME ["/tmp"]

CMD ["/bin/bash"]
