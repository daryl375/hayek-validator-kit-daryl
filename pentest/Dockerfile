FROM kalilinux/kali-rolling

# Configurar variables de entorno para optimizar instalaciones
ENV DEBIAN_FRONTEND=noninteractive \
    PATH=$PATH:/root/go/bin \
    GOPATH=/root/go

WORKDIR /pentest

# Optimizar orden de capas para mejor cache de Docker
# Instalar herramientas del sistema en una sola capa
RUN apt update && apt upgrade -y \
    && apt install -y \
        nmap \
        whatweb \
        curl \
        wordlists \
        hydra \
        sshpass \
        metasploit-framework \
        nuclei \
        golang-go \
        wget \
        git \
    && rm -rf /var/lib/apt/lists/* \
    && apt clean \
    && apt autoclean

# Configurar Go y instalar herramientas Go en una capa separada
RUN echo 'export PATH=$PATH:/root/go/bin' >> ~/.bashrc \
    && /bin/bash -c "source ~/.bashrc" \
    && go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest \
    && httpx -version

# Descomprimir rockyou.txt y crear userlist en una capa separada
RUN gzip -d /usr/share/wordlists/rockyou.txt.gz 2>/dev/null || true \
    && echo -e "root\nadmin\nuser\ntest\nguest\nsolana\nvalidator\nrpc" > /usr/share/wordlists/usernames.txt

# Copiar scripts al final para optimizar cache
COPY setup_tools.sh .
COPY aut_pentest_solana_et1_v3.12.sh .

# Dar permisos de ejecuci√≥n
RUN chmod +x setup_tools.sh aut_pentest_solana_et1_v3.12.sh

# Crear directorio de resultados
RUN mkdir -p /pentest/results

# Configurar tmpfs para mejor performance
VOLUME ["/tmp"]

CMD ["/bin/bash"]
